<ion-header>
  <ion-toolbar>
    <button ion-button menuToggle>
      <ion-icon name="menu"></ion-icon>
    </button>
    <ion-title text-center>
      <ion-icon name="stats"></ion-icon>&nbsp;&nbsp;Scrutation
    </ion-title>
    <ion-buttons end>
      <button ion-button end (click)="logout()" style="font-size: 24px">
        <ion-icon name="log-out"></ion-icon>
      </button>
    </ion-buttons>
  </ion-toolbar>
  <ion-segment *ngIf="danses.length" [(ngModel)]="danseFilter" color="secondary">
    <ion-segment-button *ngFor="let danse of danses" value="{{ danse.identifier }}">
      <span class="capitalize">{{ danse.identifier }}</span>
    </ion-segment-button>
  </ion-segment>
</ion-header>

<ion-content padding>
  <ion-grid *ngIf="competition && (!competition.judgingSystem ||  competition.judgingSystem  && competition.judgingSystem == 1)">
    <ion-refresher (ionRefresh)="doRefresh($event)">
      <ion-refresher-content></ion-refresher-content>
    </ion-refresher>
    <ion-card *ngIf="!countJudgeSheetsOfDanse(danseFilter)" class="no-sheets">
      <ion-card-content text-center>
        <ion-icon name="information-circle"></ion-icon>
        Aucune feuille de juge n'a été enregistrée pour cette danse
      </ion-card-content>
    </ion-card>
    <div *ngFor="let judgesheet of judgeSheets">
      <div *ngIf="!danseFilter || danseFilter == judgesheet.danse && judgesheet.judgeId">
        <ion-grid>
          <ion-row class="judge-title">
            <ion-col col-11>
              <h6 style="padding-top: 8px;">Juge
                <span class="capitalize">{{ judgesheet.judgeId }}</span>
              </h6>
            </ion-col>
            <ion-col col-1>
              <!-- <button *ngIf="competition && !competition.closed" ion-button icon-only color="danger" (click)="deleteJudgeSheet(judgesheet)">
                <ion-icon name="remove-circle"></ion-icon>
              </button> -->
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col col-1></ion-col>
            <ion-col col-1 class="dossard" *ngFor="let dossardAlias of dossardsAliases; let i=index">
              <span class="number">{{ dossardAlias }}</span>
            </ion-col>
            <ion-col col-1 class="dossard">
              <span class="number">#</span>
            </ion-col>
          </ion-row>
          <ion-row *ngFor="let critere of criteria">
            <ion-col col-1 class="rank uppercase">{{ critere }}</ion-col>
            <ion-col col-1 class="rate" *ngFor="let dossard of judgesheet.dossards">
              <ion-input type="text" placeholder="note" value="{{ dossard[critere] }}" disabled></ion-input>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
    </div>
    <div>
      <ion-grid>
        <ion-row>
          <ion-col col-12>
            <h5 class="judge-title">Recap
              <span class="capitalize">{{ danseFilter }}</span>
            </h5>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col col-1></ion-col>
          <ion-col col-1 class="dossard" *ngFor="let dossardAlias of dossardsAliases">
            <span class="number">{{ dossardAlias }}</span>
          </ion-col>
          <ion-col col-1 class="dossard">
            <span class="number">#</span>
          </ion-col>
        </ion-row>
        <ion-row *ngFor="let critere of criteria">
          <ion-col col-1 class="rank uppercase">{{ critere }}</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ meanCriteriaScoreOfDossardId(i, critere) }}" disabled></ion-input>
          </ion-col>
          <ion-col col-1 class="rank">
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col col-1 class="rank">TOTAL</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ scoresPerDanse(i) }}" disabled></ion-input>
          </ion-col>
          <ion-col col-1 class="rank">
          </ion-col>
        </ion-row>

        <h5>Overall</h5>
        <ion-row>
          <ion-col col-1></ion-col>
          <ion-col col-1 class="dossard" *ngFor="let dossardAlias of dossardsAliases">
            <span class="number">{{ dossardAlias }}</span>
          </ion-col>
          <ion-col col-1 class="dossard">
            <span class="number">#</span>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col col-1 class="rank">SCORE</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ overallScore(i) }}" disabled></ion-input>
          </ion-col>
          <ion-col col-1 class="rank">
            <!--{{ rankPerDanse(i, danseFilter) }}-->
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col col-1 class="rank">RANK</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ rankOverall(i) }}" disabled></ion-input>
          </ion-col>
          <ion-col col-1 class="rank">
            <!--{{ rankPerDanse(i, danseFilter) }}-->
          </ion-col>
        </ion-row>

      </ion-grid>
    </div>
  </ion-grid>

  <ion-scroll scrollX="true" style="width:100vw; height:100vw" *ngIf="competition && (competition.judgingSystem  && competition.judgingSystem == 2)">
    <ion-refresher (ionRefresh)="doRefresh($event)">
      <ion-refresher-content></ion-refresher-content>
    </ion-refresher>
    <ion-card *ngIf="!countJudgeSheetsOfDanse(danseFilter)" class="no-sheets">
      <ion-card-content text-center>
        <ion-icon name="information-circle"></ion-icon>
        Aucune feuille de juge n'a été enregistrée pour cette danse
      </ion-card-content>
    </ion-card>
    <div *ngFor="let judgesheet of judgeSheets">
      <div *ngIf="!danseFilter || danseFilter == judgesheet.danse && judgesheet.judgeId">
        <ion-grid>
          <ion-row class="judge-title">
            <ion-col col-11>
              <h6 style="padding-top: 8px;">Juge
                <span class="capitalize">{{ judgesheet.judgeId }}</span>
                <span class="callback-error" *ngIf="isJudgeSheetSKValid(judgesheet) == 2">
                  (Au delà du callback autorisé)
                </span>
                <span class="callback-error" *ngIf="isJudgeSheetSKValid(judgesheet) == -1">
                  (Callback insuffisant)
                </span>
              </h6>
            </ion-col>
            <ion-col col-1>
              <!-- <button *ngIf="competition && !competition.closed" ion-button icon-only color="danger" (click)="deleteJudgeSheet(judgesheet)">
                <ion-icon name="remove-circle"></ion-icon>
              </button> -->
            </ion-col>
          </ion-row>
          <ion-row nowrap class="back-grey">
            <ion-col col-1 class="rank">DOS</ion-col>
            <ion-col col-1 class="dossard" *ngFor="let dossardAlias of dossardsAliases">
              <span class="number">{{ dossardAlias }}</span>
            </ion-col>
          </ion-row>
          <ion-row nowrap>
            <ion-col col-1 class="rank uppercase"></ion-col>
            <ion-col col-1 class="rate" *ngFor="let dossard of judgesheet.dossards; let i=index">
              <ion-icon name="checkmark" color="primary" style="font-size: 24px;" *ngIf="dossard && isJudgeSheetSKValid(judgesheet) === 1"></ion-icon>
              <ion-icon name="checkmark" color="danger" style="font-size: 24px;" *ngIf="dossard && isJudgeSheetSKValid(judgesheet) != 1"></ion-icon>
            </ion-col>
            <!-- <ion-col col-1 class="rank">
            </ion-col> -->
          </ion-row>
        </ion-grid>
      </div>
    </div>
    <div>
      <ion-grid>
        <ion-row nowrap>
          <ion-col col-1 class="rank">TOTAL</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ scoresPerDanseSK(i) }}" disabled></ion-input>
          </ion-col>
          <ion-col col-1 class="rank">
          </ion-col>
        </ion-row>
        <h5>Overall</h5>
        <ion-row nowrap>
          <ion-col col-1 class="rank">DOS</ion-col>
          <ion-col col-1 class="dossard" *ngFor="let dossardAlias of dossardsAliases">
            <span class="number">{{ dossardAlias }}</span>
          </ion-col>
          <!-- <ion-col col-1 class="dossard">
            <span class="number">#</span>
          </ion-col> -->
        </ion-row>
        <ion-row nowrap>
          <ion-col col-1 class="rank">SCORE</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" placeholder="note" value="{{ overallScoreSK(i) }}" disabled></ion-input>
          </ion-col>
          <!-- <ion-col col-1 class="rank"> -->
          <!--{{ rankPerDanse(i, danseFilter) }}-->
          <!-- </ion-col> -->
        </ion-row>
        <ion-row nowrap>
          <ion-col col-1 class="rank">RANK</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-input type="text" [ngClass]="{'selected': rankOverallSK(i) > competition.nombreSelection}" placeholder="note" value="{{ rankOverallSK(i) }}"
              disabled></ion-input>
          </ion-col>
        </ion-row>
        <ion-row nowrap>
          <ion-col col-1 class="rank">Status</ion-col>
          <ion-col col-1 class="rate" *ngFor="let dossard of dossards; let i=index">
            <ion-icon color="secondary" name="checkmark" style="font-size: 24px;" *ngIf="rankOverallSK(i) <= competition.nombreSelection"></ion-icon>
            <ion-icon color="danger" name="close" style="font-size: 24px;" *ngIf="rankOverallSK(i) > competition.nombreSelection"></ion-icon>
          </ion-col>
          <ion-col col-1 class="rank">
            <!--{{ rankPerDanse(i, danseFilter) }}-->
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
  </ion-scroll>

  <ion-grid *ngIf="competition && (competition.judgingSystem  && competition.judgingSystem == 3)">
    <ion-row nowrap>
      <ion-col col-1 class="back-grey">RANK</ion-col>
      <ion-col col-2 *ngFor="let rank of [1, 2, 3, 4, 5, 6]; let i=index">{{ rank }}</ion-col>
    </ion-row>
    <div *ngFor="let judgeSheet of judgeSheets">
      <div nowrap *ngIf="judgeSheet.danse == danseFilter">
        <h6 style="padding-top: 8px;">Juge
          <span class="capitalize">{{ judgeSheet.judgeId }}</span>
        </h6>
        <ion-row nowrap>
          <ion-col col-1 class="rank">DOSS</ion-col>
          <ion-col col-2 class="rank" *ngFor="let dossard of judgeSheet.finalSkatingDossardsOrder; let i=index;">
            {{ dossard }}
          </ion-col>
        </ion-row>
      </div>
    </div>
  </ion-grid>
</ion-content>

<ion-footer>
  <ion-row>
    <ion-col col-12 class="legend" *ngIf="competition" text-center>
      {{ competition.titre }} - {{ competition.type.name }} - {{ competition.date | formatDate }}
    </ion-col>
  </ion-row>
</ion-footer>